%--------------------------------------------------------------------------
% SCRIPT DE VALIDAÇÃO PARA O MODELO DE ZIEGLER-NICHOLS
%--------------------------------------------------------------------------

% Passo 0: Preparação
clear; clc; close all;

%% Passo 1: Carregar os Dados Reais do Arquivo
% Nome do arquivo que você salvou na sua Current Folder
nome_do_arquivo = 'meus_dados.txt'; 

try
    dados_completos = load(nome_do_arquivo);
catch
    error('Arquivo "%s" não encontrado. Verifique se ele está salvo na mesma pasta que este script.', nome_do_arquivo);
end

% Separa os dados em vetores
tempo_real = dados_completos(:, 1);
entrada_real = dados_completos(:, 2);
saida_real = dados_completos(:, 3);

disp('Dados reais carregados com sucesso do arquivo!');

% Isola e normaliza a resposta ao degrau para a plotagem
indices_subida = find(entrada_real > 0.1, 1, 'first');
tempo_analise = tempo_real(indices_subida:end) - tempo_real(indices_subida);
saida_analise = saida_real(indices_subida:end) - saida_real(indices_subida-1);
amplitude_degrau = max(entrada_real) - min(entrada_real);

%% Passo 2: Definir o Modelo Identificado (Seus Parâmetros Z-N)
% Inserimos os parâmetros que o seu script calculou
K_zn = 0.9857;
theta_zn = 0.0032;
tau_zn = 0.1452;

% Cria a função de transferência do seu modelo
G_zn = tf(K_zn, [tau_zn, 1], 'InputDelay', theta_zn);

disp('Modelo de Ziegler-Nichols criado:');
disp(G_zn);

%% Passo 3: Simular a Resposta do Modelo Identificado
% Usamos o mesmo vetor de tempo dos dados reais para uma comparação justa
[saida_zn_simulada, ~] = step(G_zn * amplitude_degrau, tempo_analise);

%% Passo 4: Gerar o Gráfico Comparativo Final
figure;
hold on;

% Plota os dados reais (a "verdade") em azul sólido
plot(tempo_analise, saida_analise, 'b-', 'LineWidth', 2.5, 'DisplayName', 'Dados Reais');

% Plota a resposta do seu modelo em vermelho tracejado
plot(tempo_analise, saida_zn_simulada, 'r--', 'LineWidth', 2, 'DisplayName', 'Modelo Ziegler-Nichols (1ª Ordem)');

hold off;

% Configuração do Gráfico
title('Validação do Modelo: Dados Reais vs. Ziegler-Nichols');
xlabel('Tempo (segundos)');
ylabel('Amplitude de Saída');
grid on;
legend('show', 'Location', 'southeast');

%% Passo 5: Calcular o Erro Quadrático Médio (MSE)
% Garante que os vetores tenham o mesmo tamanho
len_real = length(saida_analise);
saida_zn_simulada = saida_zn_simulada(1:len_real);

mse_zn = mean((saida_analise - saida_zn_simulada).^2);

fprintf('\n--- Validação Estatística ---\n');
fprintf('O Erro Quadrático Médio (MSE) do seu modelo de Ziegler-Nichols é: %.6f\n', mse_zn);
fprintf('--------------------------------\n');
